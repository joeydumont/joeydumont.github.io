---
layout: post
title: Return user-defined sets in PostgreSQL
date: '2011-08-18T01:03:00.001-04:00'
author: jayd
tags:
- database
- programming
- linux
- postgresql
modified_time: '2012-04-14T13:26:03.056-04:00'
blogger_id: tag:blogger.com,1999:blog-3428773921792525741.post-1054910346142154411
blogger_orig_url: http://blog.joey-dumont.ca/2011/08/return-user-defined-sets-in-postgresql.html
---

<div dir="ltr" style="text-align: left;" trbidi="on"><div style="text-align: justify;"><br /></div><div class="separator" style="clear: both; text-align: center;"><a href="http://upload.wikimedia.org/wikipedia/commons/thumb/2/29/Postgresql_elephant.svg/200px-Postgresql_elephant.svg.png" imageanchor="1" style="clear: left; float: left; margin-bottom: 1em; margin-right: 1em; text-align: justify;"><img border="0" src="http://upload.wikimedia.org/wikipedia/commons/thumb/2/29/Postgresql_elephant.svg/200px-Postgresql_elephant.svg.png" /></a></div><div style="text-align: justify;">&nbsp; &nbsp;Returning sets of data with PL/pgSQL functions can be somewhat tricky. The <a href="http://www.postgresql.org/docs/9.0/static/index.html">documentation</a> has a line saying how to do it somewhere, but the beginner SQL user (like the author of this post) might be confused at the impressive amount of information given by this document.</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">&nbsp;&nbsp; This post is thus intended as an example that firsts creates a small database and a function that manipulates data. Let's do this!</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">First, let's create two tables with some data in them.</div><blockquote><div style="text-align: justify;">CREATE TABLE foo (</div><div style="text-align: justify;">"IndexFoo" integer DEFAULT nextval('"sq_IndexFoo"'::regclass) NOT NULL,</div><div style="text-align: justify;">"FOO_IndexCol1" integer NOT NULL,</div><div style="text-align: justify;">"FOO_Timestamp" timestamp without time zone DEFAULT now()</div><div style="text-align: justify;">);</div></blockquote><div style="text-align: justify;"><br /></div><div style="text-align: justify;">And a table that is pointed to by foo:</div><blockquote><div style="text-align: justify;">CREATE TABLE foo_info (</div><div style="text-align: justify;">"IndexInfoFoo" integer DEFAULT nextval('"sq_IndexFooInfo"'::regclass) NOT NULL,</div><div style="text-align: justify;">"INF_Answer" integer DEFAULT 42</div><div style="text-align: justify;"><span style="font-family: monospace; text-align: -webkit-auto; white-space: pre-wrap;">);</span>&nbsp;</div></blockquote><div style="text-align: justify;">Now say we want to return rows from both tables. Say we want the answer, given in foo_info and the timestamp, given in foo. We just have to create a function that does just</div><blockquote><div style="text-align: justify;">CREATE OR REPLACE FUNCTION "f_whatIsTheAnswer"(OUT answer integer, OUT "time" timestamp without time zone)</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">RETURNS SETOF record AS $$</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">BEGIN</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">RETURN QUERY SELECT fi."INF_Answer", f."FOO_Timestamp"</div><div style="text-align: justify;">FROM foo f</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">JOIN "foo_info" fi ON f."FOO_IndexCol1" = fi."IndexInfoFoo";</div><div style="text-align: justify;">END;</div><div style="text-align: justify;">$$ LANGUAGE plpgsql;</div></blockquote><div style="text-align: justify;">Notice how the returned columns are defined in the function's arguments. This defines the column set returned by the function. If left out, PostgreSQL will complain that the record type has not been assigned any return type.</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">Because we use PL/pgSQL, the RETURN QUERY statement is used. Since this is a simple query with no complex data manipulation, it could have been a simple SQL request. The RETURN QUERY would have been unnecessary.</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">Try it yourself! Here's the database dump.</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;"><a href="https://docs.google.com/leaf?id=0B1k3geX3BgI7ZjVjMGMwZmQtMmExOS00MjRmLTk0MGItNDk2OGMwYmMwMDI5&amp;hl=en_US">dump.sql</a></div></div>